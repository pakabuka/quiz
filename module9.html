<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>MPRE – Regulation of the Legal Profession (Module 9)</title>

  <style>
    :root{
      --bottomBarHeight: 92px;
    }

    *{ box-sizing: border-box; }

    body{
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;

      padding-bottom: calc(var(--bottomBarHeight) + env(safe-area-inset-bottom));

      background-color: #f5f5f5;
      min-height: 100vh;

      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container{
      max-width: 650px;
      width: min(92%, 650px);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.10);
      margin: 18px auto;
    }

    .hidden{ display: none; }

    .question-count{
      font-size: clamp(15px, 2.5vw, 18px);
      margin-bottom: 10px;
      color: #333;
    }

    .question{
      font-size: clamp(18px, 3.4vw, 20px);
      margin-bottom: 15px;
      line-height: 1.35;
    }

    .options button{
      display: block;
      margin: 10px 0;
      padding: 12px;
      font-size: clamp(14px, 3vw, 16px);
      cursor: pointer;
      width: 100%;
      border: 2px solid transparent;
      border-radius: 8px;
      text-align: left;
      background: #fff;
      touch-action: manipulation;
    }

    .options button.correct{
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .options button.wrong{
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .options button.selected{
      border-color: #007bff;
    }

    .options button:focus{ outline: none; }

    .navigation{
      display: flex;
      justify-content: space-between;
      margin-top: 18px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .navigation button{
      margin: 5px 0;
      padding: 10px 12px;
      font-size: clamp(14px, 3vw, 16px);
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #fff;
      touch-action: manipulation;
    }

    .explanation{
      font-size: clamp(14px, 3vw, 16px);
      margin-top: 18px;
      padding: 12px;
      background-color: #e9ecef;
      border-left: 4px solid #007bff;
      white-space: pre-wrap;
      border-radius: 8px;
      line-height: 1.35;
    }

    .primary-button{
      background-color: #007bff;
      color: white;
      border: none;
      padding: 14px 22px;
      font-size: clamp(16px, 3.2vw, 18px);
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.15s;
      display: block;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.10);
      margin: 0 auto;
      touch-action: manipulation;
    }

    .primary-button:hover{ background-color: #0056b3; transform: scale(1.02); }
    .primary-button:active{ transform: scale(0.98); }

    .secondary-button{
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px auto 0;
      display: block;
      touch-action: manipulation;
    }

    .danger-button{
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px auto 0;
      display: block;
      touch-action: manipulation;
    }

    footer{
      text-align: center;
      color: gray;
      font-size: 12px;
      padding: 10px 0;
      background-color: #f9f9f9;
      margin-top: 10px;
      border-radius: 10px;
    }

    #result-screen{
      max-height: 80vh;
      overflow-y: auto;
    }

    .review-table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 14px;
    }

    .review-table th, .review-table td{
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
      vertical-align: top;
    }

    .review-table .correct{ background-color: #d4edda; }
    .review-table .wrong{ background-color: #f8d7da; }

    .pill{
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #1e40af;
      margin-left: 6px;
      border: 1px solid rgba(30,64,175,0.18);
    }

    /* ===== Bottom Question Jump Bar ===== */
    #bottom-bar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.96);
      border-top: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 -8px 20px rgba(0,0,0,0.08);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 999;
      backdrop-filter: blur(6px);
    }

    .bottom-bar-inner{
      max-width: 650px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #bottom-bar-meta{
      flex: 0 0 auto;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
    }

    #bottom-bar-list{
      flex: 1 1 auto;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 4px 2px;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }

    #bottom-bar-list::-webkit-scrollbar{ height: 6px; }
    #bottom-bar-list::-webkit-scrollbar-thumb{
      background: rgba(0,0,0,0.18);
      border-radius: 999px;
    }

    .qnav-btn{
      flex: 0 0 auto;
      min-width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      touch-action: manipulation;
    }

    .qnav-btn:hover{ transform: translateY(-1px); }

    .qnav-btn.current{
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.18);
    }

    .qnav-btn.answered-correct{
      background: #d4edda;
      border-color: #c3e6cb;
    }

    .qnav-btn.answered-wrong{
      background: #f8d7da;
      border-color: #f5c6cb;
    }

    @media (max-width: 480px){
      .container{
        width: 94%;
        padding: 14px;
        margin: 12px auto;
        border-radius: 14px;
      }
      .options button{
        padding: 12px;
        border-radius: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="start-screen">
      <h1 style="text-align:center; margin-top: 4px;">Welcome to the Quiz</h1>
      <h4 style="text-align: center; margin: 6px 0;">MPRE</h4>
      <h5 style="text-align: center; margin: 6px 0;">Module 9 – Safekeeping Funds and Other Property</h5>

      <p style="text-align:center; color:#444; margin-top: 14px; line-height: 1.35;">
        MPRE-style questions on safeguarding client property (trust accounts), commingling, disputed funds,
        recordkeeping, notifying/delivering property, and IOLTA basics. (ABA Model Rule 1.15)
      </p>

      <button id="start-button" class="primary-button">Start Quiz</button>
      <button id="resume-button" class="secondary-button hidden">Resume Quiz</button>
      <button id="clear-progress-button" class="danger-button hidden">Clear Saved Progress</button>

      <button
        onclick="location.href='index.html'"
        style="font-size: 12px; margin-top: 10px; padding: 7px 12px; background-color: grey; color: white; border: none; border-radius: 10px; cursor: pointer; display:block; margin-left:auto; margin-right:auto;">
        Main Page
      </button>
    </div>

    <div id="quiz-screen" class="hidden">
      <div class="question-count" id="question-count"></div>
      <div class="question" id="question"></div>
      <div class="options" id="options"></div>
      <div id="explanation" class="explanation hidden"></div>

      <div class="navigation">
        <button id="prev-button" class="hidden">Go Back</button>
        <button id="next-button" class="hidden">Next</button>
      </div>
    </div>

    <div id="result-screen" class="hidden">
      <h1>Quiz Results</h1>
      <div id="final-score" style="font-size: 18px; margin-top: 6px;"></div>

      <div style="max-height: 80vh; overflow-y: auto;">
        <table class="review-table" id="review-table">
          <thead>
            <tr>
              <th>Question</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <button id="restart-button" class="primary-button">Restart Quiz</button>

      <button
        onclick="location.href='index.html'"
        style="font-size: 12px; margin-top: 10px; padding: 7px 12px; background-color: grey; color: white; border: none; border-radius: 10px; cursor: pointer; display:block; margin-left:auto; margin-right:auto;">
        Main Page
      </button>
    </div>

    <footer>
      © 2025 Frederick Liu. All rights reserved.
    </footer>
  </div>

  <!-- Bottom Question Jump Bar -->
  <div id="bottom-bar" class="hidden">
    <div class="bottom-bar-inner">
      <div id="bottom-bar-meta"></div>
      <div id="bottom-bar-list"></div>
    </div>
  </div>

  <script>
    /***********************
     *  SAVE / RESUME SETUP
     ***********************/
    const STORAGE_KEY = "mpre_module9_progress_v1";

    function saveProgress(){
      try{
        const state = {
          currentQuestionIndex,
          userAnswers,
          phase: getPhase(), // "start" | "quiz" | "results"
          savedAt: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(e){}
    }

    function loadSavedProgress(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function clearSavedProgress(){
      try{
        localStorage.removeItem(STORAGE_KEY);
      }catch(e){}
    }

    function getPhase(){
      if(!startScreen.classList.contains("hidden")) return "start";
      if(!quizScreen.classList.contains("hidden")) return "quiz";
      if(!resultScreen.classList.contains("hidden")) return "results";
      return "start";
    }

    /***********************
     *  QUESTIONS
     ***********************/
    // Module 9 — Safekeeping Funds and Other Property (ABA Model Rule 1.15)
    // Module 9 — Safekeeping Funds and Other Property (ABA Model Rule 1.15)

const questions = [
  // A) General Duty (no stealing/borrowing/use; no commingling)
  {
    question: "Rule 1.15 (general duty): When client money/property comes into a lawyer’s hands, the lawyer must:",
    options: [
      "A. Use it if the lawyer plans to pay it back soon",
      "B. Keep it separate from the lawyer’s own funds and not steal/borrow/use it",
      "C. Deposit it in the firm’s operating account if labeled “client funds”",
      "D. Treat it like a personal loan from the client"
    ],
    correct: 1,
    explanation: "No stealing/borrowing/personal use + must segregate. Commingling itself is disciplinable."
  },
  {
    question: "Commingling is best described as:",
    options: [
      "A. Holding client funds in a trust account with other clients’ funds",
      "B. Mixing client funds/property with the lawyer’s personal or business funds/property",
      "C. Depositing earned fees into the lawyer’s operating account",
      "D. Paying client expenses from a client trust account"
    ],
    correct: 1,
    explanation: "Commingling = mixing client property with lawyer’s own. (Pooling multiple clients in a trust account is normal.)"
  },

  // B) Safeguarding Property (non-money)
  {
    question: "When a lawyer receives client property (not money) to hold, the lawyer must generally:",
    options: [
      "A. Put it in the lawyer’s office desk if locked",
      "B. Identify it as client property and store it in a safe place with fiduciary-level care",
      "C. Use it if it helps the representation",
      "D. Give it to the client’s family unless client objects"
    ],
    correct: 1,
    explanation: "Rule 1.15(a): identify as client’s + keep safe like a professional fiduciary; no personal use."
  },
  {
    question: "Horse breeder leaves two valuable horses with Lawyer L for safekeeping during a transaction. L boards them at a certified and bonded stable. This is:",
    options: [
      "A. Improper—lawyer must personally house the horses",
      "B. Proper—reasonable steps to safeguard under the circumstances",
      "C. Improper—lawyer cannot hold non-monetary property",
      "D. Improper—lawyer must sell the horses and hold cash instead"
    ],
    correct: 1,
    explanation: "This mirrors the outline’s example of proper safeguarding."
  },

  // C) Client Trust Fund Account (what goes in; where; lawyer money limits; IOLTA; separate interest-bearing)
  {
    question: "Rule 1.15(a): Money received in connection with a representation (from client or third party) must:",
    options: [
      "A. Be deposited promptly into a client trust account separate from the lawyer’s accounts",
      "B. Be placed into the lawyer’s operating account if the lawyer expects to earn it",
      "C. Be held in cash until the matter ends",
      "D. Be deposited into any account the lawyer prefers"
    ],
    correct: 0,
    explanation: "Client/third-party funds connected to representation → promptly into client trust account (separate)."
  },
  {
    question: "Location of client trust account: It must be in the state where the lawyer practices unless:",
    options: [
      "A. The bank offers better interest elsewhere",
      "B. The lawyer’s firm is national",
      "C. The client or third person consents to having it elsewhere",
      "D. The lawyer labels the account clearly"
    ],
    correct: 2,
    explanation: "Default: in-state; exception: client/third-party consent."
  },
  {
    question: "A lawyer generally must NOT deposit the lawyer’s own funds into the client trust account, except:",
    options: [
      "A. To cover personal emergencies",
      "B. To pay bank service charges on the trust account",
      "C. To “show good faith” to the client",
      "D. To avoid overdrafts in the operating account"
    ],
    correct: 1,
    explanation: "Only limited lawyer funds allowed: solely to pay bank service charges."
  },
  {
    question: "If a lawyer holds a large sum for a long time on a client’s behalf, the lawyer should typically:",
    options: [
      "A. Put it in the lawyer’s operating account and track it on a spreadsheet",
      "B. Put it in a separate interest-bearing account; interest belongs to client",
      "C. Put it in a pooled IOLTA account so the bar gets the interest",
      "D. Invest it in stocks for higher returns"
    ],
    correct: 1,
    explanation: "Large/long-term funds → separate interest-bearing account for the client; interest belongs to client."
  },
  {
    question: "IOLTA accounts are used primarily when:",
    options: [
      "A. Client funds are so large they generate substantial net interest for that client",
      "B. Client funds are too small/short-term to earn net interest for the client after service charges",
      "C. The lawyer wants to avoid recordkeeping",
      "D. The client instructs the lawyer to donate interest to charity"
    ],
    correct: 1,
    explanation: "Small/short-term amounts go into pooled IOLTA; net interest goes to legal aid/charitable legal programs."
  },
  {
    question: "IOLTA interest (after bank service charges) is generally sent to:",
    options: [
      "A. The client",
      "B. The lawyer as compensation for administrative work",
      "C. The state bar or a legal foundation to fund charitable legal programs",
      "D. The court clerk"
    ],
    correct: 2,
    explanation: "That’s the IOLTA mechanism described in the outline."
  },
  {
    question: "Brown v. Legal Foundation of Washington (IOLTA) takeaway in the outline:",
    options: [
      "A. IOLTA programs are unconstitutional takings requiring client compensation",
      "B. IOLTA programs are constitutional; clients get no compensation because they lost nothing they otherwise would have had",
      "C. IOLTA programs are allowed only with client written consent",
      "D. IOLTA programs are banned in most states"
    ],
    correct: 1,
    explanation: "Supreme Court upheld IOLTA; no just compensation because client had no net interest entitlement."
  },

  // Funds that must be placed in trust: costs/expenses advances; advanced unearned fees
  {
    question: "Client advances money to pay costs/expenses not yet incurred (e.g., filing fees, experts). The lawyer must:",
    options: [
      "A. Put it in the operating account and reimburse later",
      "B. Put it in the client trust account and pay expenses from that account",
      "C. Treat it as earned on receipt",
      "D. Deposit it into a personal savings account"
    ],
    correct: 1,
    explanation: "Unincurred expenses advance → trust account."
  },
  {
    question: "Client pays an advance against legal fees that have not yet been earned. Under the outline, the lawyer must:",
    options: [
      "A. Deposit it into the operating account because it’s a fee",
      "B. Deposit it into the client trust account because it may need to be refunded if unearned",
      "C. Split it: half trust, half operating",
      "D. Immediately withdraw all of it as “earned”"
    ],
    correct: 1,
    explanation: "Unearned fee advance belongs to client until earned; must be held in trust."
  },
  {
    question: "Withdrawing advanced legal fees from trust is proper when:",
    options: [
      "A. The lawyer feels confident the client will not complain",
      "B. Fees are earned and there is no dispute about the lawyer’s right to withdraw",
      "C. The lawyer sends no bill to avoid arguments",
      "D. The client refuses to pay expenses"
    ],
    correct: 1,
    explanation: "Withdraw as earned if no dispute; many lawyers send itemized bill first to confirm no dispute."
  },

  // D) Notify, records, accountings, prompt delivery
  {
    question: "Rule 1.15 duties include all EXCEPT:",
    options: [
      "A. Promptly notify client when third party delivers funds/property for client",
      "B. Keep complete, accurate, up-to-date records and preserve them for five years after representation ends",
      "C. Render appropriate accountings",
      "D. Wait until representation ends to pay money the client is entitled to"
    ],
    correct: 3,
    explanation: "Lawyer must promptly deliver/pay over when due; not wait until end."
  },
  {
    question: "Record retention under the outline: trust/property records must be preserved for:",
    options: [
      "A. 1 year after representation ends",
      "B. 3 years after representation ends",
      "C. 5 years after representation ends",
      "D. 10 years after representation ends"
    ],
    correct: 2,
    explanation: "The outline states five years after termination of representation."
  },

  // E) Disputed Property (client vs lawyer; client vs third party; distribute undisputed)
  {
    question: "Rule 1.15(e): If property/funds are disputed among two or more claimants, the lawyer must:",
    options: [
      "A. Give everything to the client because the client is the lawyer’s loyalty target",
      "B. Keep the disputed portion separate until resolved and promptly distribute any undisputed portion",
      "C. Decide who is right and pay accordingly",
      "D. Send everything to the court automatically"
    ],
    correct: 1,
    explanation: "Hold disputed portion in trust/separate; distribute undisputed promptly."
  },
  {
    question: "Settlement check includes money for client and also for lawyer’s fee. Before the interests are accounted for/severed, the lawyer should:",
    options: [
      "A. Deposit directly into operating account because it includes fees",
      "B. Deposit into client trust account until accounting/severance",
      "C. Cash the check and hold cash in office safe",
      "D. Endorse it over to the client and ask for a new check for fees"
    ],
    correct: 1,
    explanation: "Mixed-interest funds must go to trust until accounting and severance."
  },
  {
    question: "Fee dispute: Client disputes part of the lawyer’s fee from settlement proceeds. The lawyer must:",
    options: [
      "A. Take the full claimed fee immediately and let client sue",
      "B. Keep the disputed portion in trust until resolved, while distributing undisputed amounts promptly",
      "C. Split the difference without telling the client",
      "D. Pay the disputed amount to the court clerk"
    ],
    correct: 1,
    explanation: "Disputed portion stays in trust until dispute resolution."
  },
  {
    question: "Products liability settlement: $50,000 check to Lawyer A. A bills $7,500; client agrees only $5,000 and demands all $50,000 now. Proper handling is:",
    options: [
      "A. Send client $50,000, then sue client for fees",
      "B. Keep entire $50,000 in trust until fee dispute is resolved",
      "C. Send client $42,500, transfer $5,000 to operating/personal account, and keep disputed $2,500 in trust until resolved",
      "D. Transfer $7,500 immediately to operating account and send client the rest"
    ],
    correct: 2,
    explanation: "Outline example: distribute undisputed to client, take undisputed fee, hold disputed portion in trust pending resolution."
  },
  {
    question: "Third-party interest: Client demands full recovery, but a third party has a nonfrivolous claim (by statute/common law/contract) to part of the funds. Lawyer must generally:",
    options: [
      "A. Ignore third party; pay client everything",
      "B. Refuse to surrender the disputed funds to client until third party is paid or dispute is resolved",
      "C. Decide the merits and pay whomever lawyer thinks should win",
      "D. Pay the third party immediately even if claim is frivolous"
    ],
    correct: 1,
    explanation: "If third-party claim is not frivolous and law requires protection, lawyer must hold necessary amount; but shouldn’t unilaterally arbitrate merits."
  },
  {
    question: "Client vs third-party dispute over funds held by lawyer: lawyer should NOT unilaterally arbitrate the dispute. If substantial grounds exist, lawyer may:",
    options: [
      "A. File an interpleader action to have a court resolve it",
      "B. Threaten the third party with discipline",
      "C. Pay the client and tell third party to sue",
      "D. Donate the money to charity"
    ],
    correct: 0,
    explanation: "Interpleader is the outlined option when dispute has substantial grounds; undisputed sums must be distributed promptly."
  },
  {
    question: "Three-way agreement: Lawyer A agrees to pay client C’s doctor from settlement proceeds. Client wins $10,000 but demands all funds due to a dispute with doctor. Lawyer A must:",
    options: [
      "A. Pay C the full $10,000 immediately",
      "B. Hold the amount necessary to pay the doctor until the C-doctor dispute is resolved",
      "C. Pay the doctor the entire $10,000",
      "D. Keep everything as ‘disputed’ even if some is clearly undisputed"
    ],
    correct: 1,
    explanation: "Outline example: protect nonfrivolous third-party interest (here, by agreement) by holding necessary amount."
  }
];




    /***********************
     *  QUIZ STATE
     ***********************/
    let currentQuestionIndex = 0;
    let userAnswers = [];

    const startScreen = document.getElementById("start-screen");
    const quizScreen = document.getElementById("quiz-screen");
    const resultScreen = document.getElementById("result-screen");

    const questionCount = document.getElementById("question-count");
    const questionElement = document.getElementById("question");
    const optionsElement = document.getElementById("options");
    const explanationElement = document.getElementById("explanation");

    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    const reviewTableBody = document.getElementById("review-table").querySelector("tbody");
    const finalScore = document.getElementById("final-score");

    const bottomBar = document.getElementById("bottom-bar");
    const bottomBarMeta = document.getElementById("bottom-bar-meta");
    const bottomBarList = document.getElementById("bottom-bar-list");

    const startButton = document.getElementById("start-button");
    const resumeButton = document.getElementById("resume-button");
    const clearProgressButton = document.getElementById("clear-progress-button");

    startButton.addEventListener("click", startNewQuiz);
    resumeButton.addEventListener("click", resumeQuiz);
    clearProgressButton.addEventListener("click", () => {
      clearSavedProgress();
      resumeButton.classList.add("hidden");
      clearProgressButton.classList.add("hidden");
      alert("Saved progress cleared.");
    });

    prevButton.addEventListener("click", goBack);
    nextButton.addEventListener("click", goNext);
    document.getElementById("restart-button").addEventListener("click", restartQuiz);

    const saved = loadSavedProgress();
    if (saved && Array.isArray(saved.userAnswers)) {
      resumeButton.classList.remove("hidden");
      clearProgressButton.classList.remove("hidden");
    }

    window.addEventListener("beforeunload", () => {
      saveProgress();
    });

    /***********************
     *  START / RESUME
     ***********************/
    function startNewQuiz(){
      if (questions.length === 0){
        alert("No questions have been added yet for Module 9.");
        return;
      }

      userAnswers = new Array(questions.length).fill(null);
      currentQuestionIndex = 0;

      startScreen.classList.add("hidden");
      quizScreen.classList.remove("hidden");
      resultScreen.classList.add("hidden");

      bottomBar.classList.remove("hidden");

      loadQuestion();
      saveProgress();
    }

    function resumeQuiz(){
      if (questions.length === 0){
        alert("No questions have been added yet for Module 9.");
        return;
      }

      const state = loadSavedProgress();
      if (!state || !Array.isArray(state.userAnswers)){
        startNewQuiz();
        return;
      }

      if (state.userAnswers.length !== questions.length){
        startNewQuiz();
        return;
      }

      userAnswers = state.userAnswers;
      currentQuestionIndex = Math.min(
        Math.max(parseInt(state.currentQuestionIndex || 0, 10), 0),
        questions.length - 1
      );

      startScreen.classList.add("hidden");

      if (state.phase === "results"){
        quizScreen.classList.add("hidden");
        resultScreen.classList.remove("hidden");
        bottomBar.classList.add("hidden");
        showResults();
      } else {
        quizScreen.classList.remove("hidden");
        resultScreen.classList.add("hidden");
        bottomBar.classList.remove("hidden");
        loadQuestion();
      }

      saveProgress();
    }

    /***********************
     *  BOTTOM BAR
     ***********************/
    function updateBottomBar(){
      if (quizScreen.classList.contains("hidden")) return;

      const answeredCount = userAnswers.filter(a => a !== null).length;
      bottomBarMeta.innerHTML =
        `Q <strong>${currentQuestionIndex + 1}</strong> / ${questions.length} <span class="pill">${answeredCount} answered</span>`;

      bottomBarList.innerHTML = "";

      for (let i = 0; i < questions.length; i++){
        const btn = document.createElement("button");
        btn.className = "qnav-btn";
        btn.textContent = (i + 1);

        if (i === currentQuestionIndex) btn.classList.add("current");

        const ans = userAnswers[i];
        if (ans !== null){
          if (ans === questions[i].correct) btn.classList.add("answered-correct");
          else btn.classList.add("answered-wrong");
        }

        btn.addEventListener("click", () => {
          currentQuestionIndex = i;
          loadQuestion();
          saveProgress();
        });

        bottomBarList.appendChild(btn);
      }

      const currentBtn = bottomBarList.querySelector(".qnav-btn.current");
      if (currentBtn){
        currentBtn.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
      }
    }

    /***********************
     *  LOAD QUESTION
     ***********************/
    function loadQuestion(){
      const currentQuestion = questions[currentQuestionIndex];

      questionCount.textContent =
        "Question " + (currentQuestionIndex + 1) + " of " + questions.length;

      questionElement.textContent = currentQuestion.question;

      optionsElement.innerHTML = "";
      explanationElement.classList.add("hidden");
      explanationElement.textContent = "";

      currentQuestion.options.forEach((option, index) => {
        const button = document.createElement("button");
        button.textContent = option;

        if (userAnswers[currentQuestionIndex] === index){
          button.classList.add("selected");
        }

        button.addEventListener("click", () => {
          handleAnswer(index);
        });

        optionsElement.appendChild(button);
      });

      if (userAnswers[currentQuestionIndex] !== null){
        showAnswerFeedback(userAnswers[currentQuestionIndex], false);
      }

      prevButton.classList.toggle("hidden", currentQuestionIndex === 0);

      if (userAnswers[currentQuestionIndex] !== null) nextButton.classList.remove("hidden");
      else nextButton.classList.add("hidden");

      updateBottomBar();
      saveProgress();
    }

    function showAnswerFeedback(selectedIndex, lockButtons){
      const currentQuestion = questions[currentQuestionIndex];
      const buttons = optionsElement.querySelectorAll("button");

      buttons.forEach((btn, idx) => {
        btn.classList.remove("correct", "wrong");

        if (idx === currentQuestion.correct){
          btn.classList.add("correct");
        }

        if (idx === selectedIndex && selectedIndex !== currentQuestion.correct){
          btn.classList.add("wrong");
        }

        btn.disabled = !!lockButtons;
      });

      userAnswers[currentQuestionIndex] = selectedIndex;

      explanationElement.textContent = currentQuestion.explanation;
      explanationElement.classList.remove("hidden");

      nextButton.classList.remove("hidden");

      updateBottomBar();
      saveProgress();
    }

    function handleAnswer(selectedIndex){
      showAnswerFeedback(selectedIndex, true);
    }

    /***********************
     *  NAV
     ***********************/
    function goNext(){
      if (currentQuestionIndex < questions.length - 1){
        currentQuestionIndex++;
        loadQuestion();
      } else {
        showResults();
      }
      saveProgress();
    }

    function goBack(){
      if (currentQuestionIndex > 0){
        currentQuestionIndex--;
        loadQuestion();
      }
      saveProgress();
    }

    /***********************
     *  RESULTS
     ***********************/
    function showResults(){
      quizScreen.classList.add("hidden");
      resultScreen.classList.remove("hidden");
      bottomBar.classList.add("hidden");

      const correctAnswers = userAnswers.filter((answer, index) => {
        return answer === questions[index].correct;
      }).length;

      finalScore.textContent =
        "You got " + correctAnswers + " out of " + questions.length + " questions correct.";

      reviewTableBody.innerHTML = "";

      questions.forEach((q, index) => {
        const row = document.createElement("tr");

        if (userAnswers[index] === q.correct) row.classList.add("correct");
        else row.classList.add("wrong");

        const questionCell = document.createElement("td");
        questionCell.textContent = q.question;

        const statusCell = document.createElement("td");
        statusCell.textContent = userAnswers[index] === q.correct ? "Correct" : "Wrong";

        row.appendChild(questionCell);
        row.appendChild(statusCell);
        reviewTableBody.appendChild(row);

        row.addEventListener("click", () => {
          reviewQuestion(index);
        });
      });

      saveProgress();
    }

    function reviewQuestion(index){
      currentQuestionIndex = index;

      resultScreen.classList.add("hidden");
      quizScreen.classList.remove("hidden");
      bottomBar.classList.remove("hidden");

      loadQuestion();

      let backToResultsButton = document.getElementById("back-to-results-button");
      if (!backToResultsButton){
        backToResultsButton = document.createElement("button");
        backToResultsButton.id = "back-to-results-button";
        backToResultsButton.textContent = "Back to Results";
        backToResultsButton.className = "secondary-button";
        backToResultsButton.addEventListener("click", showResults);
        quizScreen.appendChild(backToResultsButton);
      }

      saveProgress();
    }

    /***********************
     *  RESTART
     ***********************/
    function restartQuiz(){
      clearSavedProgress();
      location.reload();
    }
  </script>
</body>
</html>
